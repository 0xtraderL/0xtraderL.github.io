---
layout: post
title: "Sui上でのLP自動リバランスツール"
date: 2025-6-28 12:00:00 +0800
categories: [DeFi]
tags: [defi, bluefin, sui, clmm]
lang: ja
---

集中流動性プールでLPを組んで手数料収益を得る際、価格が範囲外になること、つまりLP流動性ポジションの価格範囲から外れる状況によく遭遇します。この場合、手動でポジションを再構築しなければ、収益を得ることができません。手動でのポジションリバランスは少し面倒です。投入資金が変わらないと仮定して、元のポジションの残りトークン数量に基づいて計算すると：

1. 元のポジションを閉じて、すべての流動性を引き出す - この取引には1回の署名が必要です。
2. 新しいポジションの価格範囲を考慮して、必要なトークンAとBの量を計算し、対応する量のAまたはBをスワップする - このスワップ取引には1回の署名が必要です。
3. ステップ2で得られた量と事前設定された価格範囲に基づいて、流動性を再追加してポジションを確立する - これには1回の署名が必要です。

手動でのLPリバランスには上記の3つのステップが必要で、ステップ2はツールなしでは計算が困難です。現在、AlphaFiなどの多くの自動バランシングオンチェーンプロトコルがあり、範囲外になったときに自動でバランスを取ることができますが、価格範囲はプロトコルによって決定され、自身の戦略に応じて調整することはできません。通常、価格範囲は非常に大きく、少数の主要プールにのみ適用され、面倒を避けたい怠け者のユーザーに適しています。私はこのようなプロトコルをほとんど使用しません。

## Sui PTB機能による1クリックリバランス

イーサリアムでは、オンチェーンコントラクトを使用せずにオフチェーンでこの問題を解決する方法を実際に知りません。しかし、Suiでは、この問題は問題ではありません。ここでSuiを褒めさせてください - Suiは実際の問題を解決するために生まれたブロックチェーンであり、様々なアプリケーションの開発に非常に適しており、ガスコストが低く、セキュリティが高く、速度も速く、スポンサー取引、ZkLogin、PTBプログラミングなどの多くの機能があり、ユーザーフレンドリーで革新的なアプリを簡単に実装できます。

PTB機能に焦点を当てましょう。これは実際に非常に強力です：

PTB（Programmable Transaction Block）とは、簡単に言えば、オフチェーンでトランザクションを構築する際に、複数の操作を一度にパッケージできることです。普通に見えますが、実際の応用シナリオは非常に広いです。

**従来のオンチェーン操作の問題：**
- 複雑な操作を複数の独立したトランザクションに分解する必要がある
- 各トランザクションには個別の署名確認が必要で、プロセスが煩雑
- 任意のステップが失敗すると、前の操作が既に実行されている可能性がある
- ガス手数料が蓄積し、コストが増加する

**PTBの利点：**
- 複数の操作をオフチェーンで1つのトランザクションブロックに組み立てる
- 1回の署名で、すべて成功するかすべて失敗するか
- アトミック実行で、中間状態を回避
- 本質的に単一のトランザクションであるため、ガス手数料が大幅に削減

実際の例：LPリバランス操作、従来のEVMの方法では：
1. 流動性を引き出す → 署名確認 → 待機
2. トークンをスワップして比率を調整する → 署名確認 → 待機
3. 流動性を再追加する → 署名確認 → 待機

PTBを使用する場合：
1. オフチェーン構築：
   - ポジションを閉じて流動性を引き出し、引き出されたトークン量を取得（トランザクションはまだ実行されておらず、トークンはまだこのトランザクション内にあり、次の操作に渡すことができます）
   - 前のステップのトークン量に基づいてスワップ
   - スワップステップの量に基づいてポジションを再作成
2. 上記のトランザクションを1回の署名で提出
3. オンチェーンでアトミック実行

PTBを使用すると、オフチェーンでフラッシュローンアービトラージを実行することもできます。これはイーサリアムシステムではコントラクトを開発することによってのみ可能です。

これが私がSuiで1クリックリバランスを実装できる理由であり、他のチェーンではこのような操作のコストと複雑さが高いのです。

## 私のワークフロー

1. 最初に資金を投入してポジションを作成
2. ポジションの状態を監視し、範囲外になったらTelegram通知を送信
3. 範囲外になった後、リバランスワークフローを使用して、元のポジションが現在の価格範囲で収益を得続けるようにする
4. 履歴ポジションの収益を観察し、ポジションの価格振幅を調整

LP収益統計：
![LP収益統計](/assets/img/posts/2025-06-28/1.webp)

LPリバランス実行プロセス：
![LPリバランス実行プロセス](/assets/img/posts/2025-06-28/3.png)

使用したワークフローツール：

- ポジション範囲外監視
- 1クリックリバランス
  - [Bluefin](https://app.kamechan.xyz/workflow/traderL/bluefin-spot-automated-percentage-based-rebalancing)
  - [Momentum](https://app.kamechan.xyz/workflow/traderL/mmt-automated-liquidity-position-rebalancing)
- 履歴ポジション収益（LP vs Holding）
  - [Bluefin](https://app.kamechan.xyz/workflow/traderL/bluefin-spot-yield-comparison-lp-vs-holding)
  - [Momentum](https://app.kamechan.xyz/workflow/traderL/momentum-pool-yield-comparison-lp-vs-holding) 